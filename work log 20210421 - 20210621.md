## 04/20 - 21

- https://theplanttokyo.atlassian.net/browse/MDX-2149 Purchase event is not including grill items in the item collection
  - 完成。
  - 顺带修复了一处 single_item 和 set_item 参数的错误【参照 ios 的代码修复】
  - 截图供给 ios 进行事件对比
- https://theplanttokyo.atlassian.net/browse/OVF-834 VLSC > End of campaign > Tap stamp banner > App crash
  - 查明了 crash 的原因。Fixed
- https://theplanttokyo.atlassian.net/browse/MDX-2142 Push Device Token to Firestore
  - 继续调用冲突问题



![image-20210426143522680](/Users/john/Library/Application Support/typora-user-images/image-20210426143522680.png)

# Sprint 25(4.21-5.11)：21plan 22 23 dev 25 26 27 dev 28/29/30-qa/uat/review



## 04/22-23 dev

- charles 抓包：https://www.charlesproxy.com/documentation/using-charles/protocol-buffers/

- https://theplanttokyo.atlassian.net/browse/MDX-2142 Push Device Token to Firestore

  - 已经尝试的情况：

    1. wmob 和 jma 使用 protobuf-lite 生成的类（代码）和 protobuf-full 生成的代码不一样，只有 protobuf-full 有现成的 json to protobuf model 的转换，lite 未提供

       > 生成代码不一样主要是继承关系和模型对外方法的不同

    2. 全部使用 protobuf-full 的情况，相当 exclude 了 firebase 下，包括 firebstore ，使用的 protobuf-lite 把生成类都交给 protobuf-full 生成，导致内部方法调用的时候出现了参数类型错误的问题

       > java.lang.VerifyError: Verifier rejected class com.google.firestore.v1.Value: void com.google.firestore.v1.Value.mergeTimestampValue(com.google.protobuf.Timestamp) failed to verify: void com.google.firestore.v1.Value.mergeTimestampValue(com.google.protobuf.Timestamp): [0x19] register v4 has type Precise Reference: com.google.protobuf.Timestamp but expected Reference: com.google.protobuf.GeneratedMessageLite (declaration of 'com.google.firestore.v1.Value' appears in /data/app/jp.co.mcdonalds.android.staging-e9pxpf6xMwSKBP7ixrETdg==/base.apk!classes3.dex)

    3. firebase 的其他依赖对 protobuf 的依赖程度不高，exclude 并没有产生问题，但是 firestore 问题比较大，因此进行对 firestore 单独处理。分别将 firestore 降低到了 21.4.3 版本，和 15.0.0 版本进行尝试，都出现了不同原因的不兼容问题

       > 21.4.3 版本使用了 protobuf-javalite3.0。protobuf-javalite3.0-3.7 和 3.8 以后的版本不兼容，之前有记录通过该方法解决过兼容性问题，即 javalite3.0 生成的类和 protobuf-java 生成的类可兼容，故作尝试。报错已经排除和 firebase 其他依赖的冲突问题导致的错误（基于 bom 做过版本同步），可以明确是和 protobuf-java 的不兼容
       >
       > 
       >
       > 15.0.0 版本是 firestore 没有使用 protobuf 的版本，这个由于年代太老，也无法做到兼容，直接报了“初始化异常”

  - 还可做的尝试：

    - 是否可以通过 gson 或者其他工具将 json(string) 转成 protobuf-javalite 生成的类（这个没有现成的方法，实现难度或许也比较大）
    - 最差的情况：直接将 wmob api 返回的 json 数据转为 java model 而不是 protobuf model，需要评估工作量是否可行

## 04/25-26 dev

- https://theplanttokyo.atlassian.net/browse/MDX-2142 Push Device Token to Firestore

  - 无法使用  gson 或者其他工具将 json(string) 转成 protobuf-javalite 生成的类
  - 开始替换 protobuf model -> java model。**进行时**

  > https://github.com/firebase/firebase-android-sdk/issues/2165 google firebase 团队也明确给出了方案
  >
  > 客户端就两个方案：
  >
  > 1. 全部迁移到 protobuf-javalite
  > 2. 将 firesbase fork 出去，修改所有的依赖为 protobuf-full，但是工作量和稳定性都不切实际



- https://theplanttokyo.atlassian.net/browse/OVF-868 Campaign page > Tap coupon link >Jump to home page.
- https://theplanttokyo.atlassian.net/browse/OVF-887?focusedCommentId=94803&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-94803







在线学习：https://theplant.udemy.com/ 



Fix crash in this sprint: 

https://console.firebase.google.com/u/1/project/nth-glass-770/crashlytics/app/android:jp.co.mcdonalds.android/issues/08ec611621b744ff5b14155ff76d4339?time=last-seven-days&sessionEventKey=603C6D0902A8000122B328088EB82999_1512980608805297049

> [CouponQrcodeFragment.java line 65](https://console.firebase.google.com/u/1/project/nth-glass-770/crashlytics/app/android:jp.co.mcdonalds.android/issues/08ec611621b744ff5b14155ff76d4339?time=last-seven-days&sessionEventKey=603C6D0902A8000122B328088EB82999_1512980608805297049#)



## 04/27-28 dev

https://theplanttokyo.atlassian.net/browse/MDX-2142 Push Device Token to Firestore

放弃执行 protobuf model -> java model 的替换，protobuf model 涉及到的调用太多，直接替换造成的改动和冲突处理工作量都非常大

执行 json -> java model 创建并填充原来的 protobuf model，这样的改动最小，但是工作量也非常大

dir.proto 100%

api.proto 80%



## 04/29 dev

https://theplanttokyo.atlassian.net/browse/MDX-2142 Push Device Token to Firestore

- 根据 dir.proto & api.proto  完成 java 模型的定义，并在解析 json 后创建 java model 后填充到 protobuf model
- 由于 protobuf-full 已经替换成了 protobuf-javalite，还需要解决下面几个问题：
  - 缺少时间工具类 Timestamps。直接从 google 开源代码中抽出来添加进去。 Done
  - protobuf model 继承统一父类不再是 message（很多地方有用这个类），需要替换。替换成 MessageLite。Done
  - 还有好几个地方存在 json to protobuf model 以及 protobuf model to json 的地方，目的为了存，都还需要单独去处理
    - 使用 base64String 替代 jsonString，再存入 sp。Done
  - intent 无法再传递 protobuf model，因为 Message 实现了 parcelable，但是 MessageLite 没实现，需要全部用别的方式进行 intent 传值
    - 使用 protobufModel.toByteArray() 进行传值（byte[]），再反向解析。Done
- **测试。Protobuf Model 填充构建不允许 null 值，还抽点时间需要 fix 该问题**



## 05/06  dev

- https://theplanttokyo.atlassian.net/browse/MDX-2142 Push Device Token to Firestore
  - 状态：Review。假期的时候已经修复java model 转 protobuf model 过程中不支持 null 值的问题，提交了 PR
- https://theplanttokyo.atlassian.net/browse/OVF-887?focusedCommentId=94803&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-94803
  - 核对 json map
- https://theplanttokyo.atlassian.net/browse/MKP-67
  - 为 deeplink 点击进入 store 的操作添加了 map_select_store 事件。但是不知道是否需要在这个 sprint 完成合并



## 05/07  qa

- 查看并修复转变 protobuf-javaLite 之后 order 无法 checkout 问题
- 打包：build 265
- https://theplanttokyo.atlassian.net/browse/OVF-868 Campaign page > Tap coupon link >Jump to home page.
  - fixed



## 05/08  qa

- 调查 protobuf 转变后为 protobuf-javalite 后未完成订单的丢失问题
  - 是否可以恢复（恢复 json 字符串都 protobuf，需要先转为 java model，然后再改为 protobuf，比较麻烦和费时）
  - 是否可以重新下单（可以）



## 05/10

- https://theplanttokyo.atlassian.net/browse/MDX-2171 [Firestore] Send registration token only if it's new

  - 状态：完成
  - https://github.com/theplant/mcd-android/tree/2171/optimizeRegistrationToken

- https://theplanttokyo.atlassian.net/browse/MDX-2162 [d point] [Android] Checking the d point registration status via getCrossRerefence API doesn't work correctly.

  > https://theplanttokyo.atlassian.net/browse/MDX-1718

  - 状态：了解任务内容



# Sprint 26  05/12 Plan



## 05/11-12

- 检查 Sprint 26 Android 的任务
- https://theplanttokyo.atlassian.net/browse/MDX-1887 [Android] Coloring book PDF does not download
  - webview 支持文件的下载，包括 pdf。**创建 PR**
- https://theplanttokyo.atlassian.net/browse/MDX-2171 [Firestore] Send registration token only if it's new
  - 改变 save token 的时机为 send firestore 成功之后。**创建 PR**



## 05/13-14 dev

- https://theplanttokyo.atlassian.net/browse/MDX-2162 [d point] [Android] Checking the d point registration status via getCrossRerefence API doesn't work correctly.

  - **block**

  - 重新登录 dpont 需要执行 2 步：

    1 退出，2 再登录。当前退出使用了 clearCardInfo()，但是文档提及该方法会清除 “除了认证信息缓存外的所有信息”，因此再次登录的时候由于依然存在认证信息缓存，会直接使用上次登录的 dp 账号，无法重新进入填写账号的页面

    后追加了 clearAllInfo()，但是该方法依然无法清除认证信息，依然会会使用上次登录的 dp 账号，直接打开 dpoint card

  - dpoint sdk 的文档：dpoint 只提供了 clearCardInfo() 和 clearAllInfo() 方法来清除数据



## 05/17-18

- https://theplanttokyo.atlassian.net/browse/MDX-2162 [d point] [Android] Checking the d point registration status via getCrossRerefence API doesn't work correctly.
  - 尝试用其他方式对 sdk 的缓存进行清理，无果，属于 dpoint sdk 内部问题，暂时先不去解决
  - 任务完成
- https://theplanttokyo.atlassian.net/browse/MDX-2172 [Android] "MXX"(OrderNumber) may not be displayed after CheckedIn
  - 尝试重现



## 05/19 Wednesday

- https://theplanttokyo.atlassian.net/browse/MDX-2172 [Android] "MXX"(OrderNumber) may not be displayed after CheckedIn

  结果：

  1. 记录的案例并无数据，mop 在 stag/uat 找不到那几个出错的 store 无法使用记录的数据进行复现
  2. 不在记录内的案例，无法复现
  3. 可能的原因：
     1. checkin 页面到 pickup 页面之后，该页面崩溃。理论上不可能，用实际代码测试故意奔溃也并未发生该情况，**排除**
     2. 比较有可能的情况是 checkin 之后到得到 fullOrder 数据没有 displayOrderNumber 字段

  

## 05/20-21 

- Code Review
- 分析 Neo 提出的 UAT 的 crash 问题，由于是之前版本就有的问题，所以先不去做修改
- https://theplanttokyo.atlassian.net/browse/MDX-2172 [Android] "MXX"(OrderNumber) may not be displayed after CheckedIn
  - 分析 firebase 上几个出现问题的 sample 的 purchase 事件数据，prod 上已经无法找到完整的产品数据，无法去 prod 环境复现





# Sprint 27 5/26 plan

## 05/24-25

- https://theplanttokyo.atlassian.net/browse/MMF-314 Open notification on front-end > Show additional text box
  - 原因找到了，gcm 的 notification 应该都会有弹窗，但是得再了解下业务才能下手改（得明确哪些场景需要弹窗）
  
  - 5.25 确认可以修改，**Fixed**
  
    > showDialog：BaseActivity 913
    >
    > Bundle[{fromSplash=true, gcmDialogDisable=false, gcmTitle=Android Front Coupon, isGcm=true, clickThroughUrl=mcdonaldsjp://setting, gcmMessage=Open menu}]
  
- https://theplanttokyo.atlassian.net/browse/MMF-290 [ Run on backen for 5 minitues > PLP doesn't work well.]
  - 查明原因是由于内存不足，页面回收
  - 状态：**in_progress，先执行 sprint27 的主要任务**

## 05/26

- https://theplanttokyo.atlassian.net/browse/MDX-2192 [Analytics] why is "screen name" not being set for a majority of screen views 
  - 找到了原因：为 firebase sdk 内部自动采集事件的原因

  - ```xml
    <meta-data
        android:name="google_analytics_automatic_screen_reporting_enabled"
        android:value="false"/>
    ```
    
  - 状态：**等待 Larry 做最后的决定**

## 05/27-28

- https://theplanttokyo.atlassian.net/browse/MDX-2189  JMA support McD LTO Campaign product availability control
  - 确认 MDX-2189 需求：
    - 根据新加的两个时间字段（mop_availability_start/end）来控制 Generic Menu PLP 和 PDP 的 CTA 按钮是否为 enable 状态 （**缺少设计稿：向 nate 索要 disable 的设计**）
    
    - WebMop 和 JMA: Store Menu 里面的数据由服务端数据源直接控制是否显示，因此不需要修改
    
    - order 按钮 隐藏逻辑需要更新为
    
      ```java
      (R.id.order, !it.rfm_code.isNullOrBlank() && it.rfm_code != "0") && !it.hide_buy_button
      ```
    
  - 状态：**完成**




| mop_availability_start | mop_availability_end | hide_buy_button | PLP order/PDP CTA button                                  |
| ---------------------- | -------------------- | --------------- | --------------------------------------------------------- |
| blank                  | blank                | false           | show: enable                                              |
| blank                  | blank                | true            | hide                                                      |
| present                | blank                | false           | show: enable after 'start', otherwise disable             |
| blank                  | present              | false           | show: enable before 'end', , otherwise disable            |
| present                | present              | false           | show: enable between 'start' and 'end', otherwise disable |
| present                | present              | true            | hide                                                      |
| present                | blank                | true            | hide                                                      |
| blank                  | present              | true            | hide                                                      |

## 05/31-06/02

- https://theplanttokyo.atlassian.net/browse/MDX-2189  JMA support McD LTO Campaign product availability control
  - 最终确认改动，Android 无需再更改

- https://theplanttokyo.atlassian.net/browse/MMF-344 iOS 298 / Android 281> PLP/PDP > Hide buy button ture > Different behaviour
  - 对于字段 hide_buy_button 为 true 的时候，显示何种效果。再次确认需求，Android 无需修改
- https://theplanttokyo.atlassian.net/browse/MDX-1616 Remove Kochava SDK as Event Tracking has been shifted to AppsFlyer
  - 状态：完成

## 06/03-04

- https://theplanttokyo.atlassian.net/browse/MMF-346 Different behavior for diable/able to click the order button
  - 可接受无需修改
  
- https://theplanttokyo.atlassian.net/browse/MDX-2265 Android> "App side management  Coupon banner" transition doesn't work well 

  - **Branch**：https://github.com/theplant/mcd-android/tree/mdx2265/couponBannerClick
  - **没有测试数据验证**
  - https://theplant.slack.com/archives/C019C3FKUJK/p1622786888119700

- https://theplanttokyo.atlassian.net/browse/MDX-2208 [Android] "MXX"(OrderNumber) not display after CheckedIn

  - 从信息：

    > 1. (from Zendesk) Code: 50180 (5.1.80(244)) · Manufacturer: Huawei · CPU make: HiSilicon · CPU model: KIRIN658 · Platform: ABI_ARM64_V8,ABI_ARM_V7,ABI_ARM

    猜测设备应该是：

    - Huawei P10 Lite，Huawei Nova Youth 但是之前用过的远程设备平台没有这两个机型
    - 试了一下 Huawei Nova 2 也可以重现该问题





> @Aki Iinuma Thank you for the device information. According to the CPU model: KIRIN658 and Manufacturer: Huawei, I think the devices that can reproduce this issue may be the Huawei P10 lite and Huawei Nova Youth, but unfortunatelly, we don’t have these two devices and remote devices platform don’t have too.
>
> So I just use remote devices 'Huawei Nova 2', which has the similar hardware configuarion as Huawei Nova Youth



# Sprint 28 06/09 plan

## 06/07-08

- https://theplanttokyo.atlassian.net/browse/MDX-2265 Android> "App side management  Coupon banner" transition doesn't work well 
  - **Branch**：https://github.com/theplant/mcd-android/tree/mdx2265/couponBannerClick
  - **状态：完成**

- https://theplanttokyo.atlassian.net/browse/MDX-2208 [Android] "MXX"(OrderNumber) not display after CheckedIn
  - Huawei P10 Lite，Huawei Nova Youth 这两个机型没有，使用类似机型去复现一下
  - Huawei Nova 2 可以复现、Huawei P10 无法复现
  - Branch: https://github.com/theplant/mcd-android/tree/mdx2208/orderNum
  
    

## 06/09-11

- https://theplanttokyo.atlassian.net/browse/MDX-2285  [Analytics] add AppsFlyer "af_content_view" to homes screen promotion views
  - **状态：完成**
- https://theplanttokyo.atlassian.net/browse/MDX-2208 [Android] "MXX"(OrderNumber) not display after CheckedIn
  - 同步修复 webmop 
  - 录制 fix 视频
  - **状态：完成**

- https://theplanttokyo.atlassian.net/browse/MMF-319 Mop>UAT>Android (277)>Can not order again.
  - **状态**：特殊机型，摸机器和私人真机无法复现，正在尝试通过代码逻辑查明原因



## 06/15-16-17-18（4days）

- https://theplanttokyo.atlassian.net/browse/MDX-2287 Update schema link mcdonaldsjp://login
  - fix 登录之后点击 ‘login’ or ‘register’ 依然跳转登录页面问题
- https://theplanttokyo.atlassian.net/browse/MDX-2208 [Android] "MXX"(OrderNumber) not display after CheckedIn
  - 录制 before/after fix 视频
- https://theplanttokyo.atlassian.net/browse/MMF-319 Mop>UAT>Android (277)>Can not order again.
  - **状态**：特殊机型，摸机器和私人真机无法复现
  - 代码逻辑上未发现异常，需要真机调试查看

- https://theplanttokyo.atlassian.net/browse/MMF-360 MOP>UAT>Android(283)>previous order banner > Fanta Melon(L)>Can not find this product
  - 已经找到原因，数据和逻辑不匹配，要么改数据，要么改逻辑。
  - ios 无此bug，应该是逻辑不同
- 整理测试点 & Code Review
