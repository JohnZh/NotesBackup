# work log 2020/12/11 - 2021/02/10 (两月)



## 2020/12/11 Friday

- 了解新任务 https://theplanttokyo.atlassian.net/browse/MDX-1543 
- 继续查看 bug：https://theplanttokyo.atlassian.net/browse/MMF-65



## 2020/12/14 Monday

- 调查 banner 或者外部 url 打开 webview 之后进行下单为什么有的设备可以跳转，有的不行

  - 任务id https://theplanttokyo.atlassian.net/browse/MMF-68

  > 1. URL 是& (https://www.mcdonalds.co.jp/campaign/sankakuchocopie/?m=1&utm_medium=JMA&utm_source=JMA&utm_campaign=home-promo-chocopie)
  > 2. URL的%26 (https://www.mcdonalds.co.jp/campaign/sankakuchocopie/?m=1%26utm_medium=JMA%26utm_source=JMA%26utm_campaign=home-promo-chocopie)
  >
  > 1. 安卓webview加载URL 1的时候后面的参数全没了。只剩下 `?m=1` 然后JS判断没有``utm_source=JMA`` 的值就跳转到``https://www.mcdonalds.co.jp/order?productCode=2162&deeplink=https://jtdu.app``....` 这个URL去。然后线上版本的安卓APP会打开APP的产品页面去（[@lin](https://theplant.slack.com/team/U010L4AD3PB) Universal Links）**我手机测试的时候等了将近8秒才从页面跳转到app的产品页面。**
  > 2. 安卓webview加载URL 2的时候会把%26转义成&符号。后面的参数全在。JS读取到`utm_source=JMA` 的值。跳转到 `mcdonaldsjp://product?code=2162&price=150...` 这个URL去。但是线上的安卓版本是没有处理这个URL的。所以页面没有任何反应

  >Android 这边估计是由于历史功能需要，对 & 的 url 进行了拆解，但是最后加载的时候没有进行拼接，因此导致参数的丢失；而带 %26 的 url 它会把 %26和后面的 key=value都作为字符串，所以参数不会丢失。

- 继续读 https://theplanttokyo.atlassian.net/browse/MMF-65 优惠券产品选择逻辑



## 2020/12/15 Tuesday

- 体检

- 继续读 https://theplanttokyo.atlassian.net/browse/MMF-65 优惠券产品选择逻辑

  - 找到了原因，老代码刷新方式有问题，将数据和和view 绑定在了一起。但是 recyclerview 是会重用布局的，而且只缓存 5 个 view，每次 notifydatachanged 少于5 个 view 位置还不会发生变化，但是多于 5 个 view 的时候，方法会重新创建新的 view，缓存的 view 会上移，数据和 view 绑定，也就意味着数据也移动了。因此绝对不能把数据和重用的 view 绑定在一起，你根本不知道下一次刷新后原先的 view 在什么位置了

  

## 2020/12/16 Wednesday

- https://theplanttokyo.atlassian.net/browse/MDX-1864 分析这个问题产生的原因（看代码）
- https://theplanttokyo.atlassian.net/browse/MDX-1874 
  - 不同数据来源于 coupon 和常规的产品，二次修改源数据的做法不严瑾，因为数据客户是可以任意修改的



## 2020/12/17 Thursday

- https://theplanttokyo.atlassian.net/browse/MDX-1881

  - 对比了 en 和默认的 string\style 之后删除了没必要的 en 配置，默认就是 en
    - 原因：i18n 一份语言对应多份文件增加了修改文字不完整这种低级错误产生的概率
    - 因此，在对比完 en 配置为默认配置的子集后，保留默认配置，删除不必要的 en 的配置，从而减小产生错误的概率

- https://theplanttokyo.atlassian.net/browse/MDX-1846 替换字体

- https://theplanttokyo.atlassian.net/browse/MDX-1845 删除老字体

  - 删除引用了老字体，但是本身并没有被引用的布局文件和 activity 和 Fragment

    - archsans_regular.tff -> fragment_store_map -> StoreMapFragment -> StoreHistoryFragment(fragment_store_history ) -> StoreChooserFragment(fragment_store_chooser)（未被使用）

    - arch_sans_regular.xml -> category_list_item.xml -> CategoryListFragment(fragment_category_list)

    - arch_sans_regular.xml -> fragment_card_add.xml

    - arch_sans_regular.xml -> include_store_info_layout.xml

    - arch_sans_regular.xml -> include_text_image_arrow_row

    - arch_sans_regular.xml -> include_text_n_arrow_layout

    - arch_sans_regular.xml -> offer_list_item

    - arch_sans_bold.xml -> activity_store_details

    - arch_sans_bold.xml -> content_menu_new.xml -> MenuAdapter(MainHolderNew) -> MenuFragment(fragment_menu)(无被使用)

    - arch_sans_bold.xml -> product_list_item

    - arch_sans_bold.xml -> fragment_store_details.xml -> StoreDetailsFragment(未被使用)

      

## 2020/12/18 Friday

- https://theplanttokyo.atlassian.net/browse/MDX-1845 删除老字体

  - 删除引用了老字体，循环引用的类，没有被主流程引用

    - arch_sans_bold.xml -> card_list_item(CardItemViewModel) -> CardListAdapter -> CardSelectViewModel 

      -> updateItems(cardList: List<Card>, cardSelectViewModel: CardSelectViewModel, isFromSideMenu: Boolean)

      -> ViewHolder.bind(card: Card, cardSelectViewModel: CardSelectViewModel, isFromSideMenu: Boolean)

  - 对引用了老字体，被主流程使用，并使用了新样式的页面进行老字体的删除

    - 属性设置老字体会比设置样式的优先级高，因此这其实是一个肉眼很难辨认的 bug
      - store_opening_hours_item.xml

  - 引用了老字体，但是不可见的 view，直接删除老字体属性，不理会 view（反正不可见）

    - arch_sans_bold.xml -> store_feature_list_item(引用了老字体的 view 是隐藏的 store feature name 为 “”) -> FeaturesListAdapter -> StoreViewModel.getFeaturesListAdapter() -> activity_store_details_new + fragment_store_details + store_list_item

  - 删除了使用老字体的布局，这个布局虽然被Adapter 引用，但是 adapter 并未被使用

    - arch_sans_bold.xml -> order_list_item（OrderItemViewModel） -> OrderListAdapter -> FullOrderViewModel + OrderCollectViewModel + OrderConfirmModel.kt(未使用)

      FullOrderViewModel.orderListAdapter -> FullOrderViewModel.loadData() （未使用，这意味着 orderListAdapter 也没被使用）

      OrderCollectViewModel.orderListAdapter -> OrderCollectViewModel.loadData() -> orderListAdapter（未被使用）

  -  **只是先替换了字体，这个地方逻辑太过复杂，不敢随意删除**（后面有时间再看）

    - arch_sans_bold.xml -> fragment_product_choice_list(ProductChoiceListViewModel) -> ProductChoiceListFragment -> ProductDetailsAdditionAddFragment/ProductDetailsItemView/ProductDetailsMaxSetAddFragment/ProductDetailsMultipleFragment



## 2020/12/21 Monday

- 对比 prod 环境的 apk 从 5.1.50 -> now(5.1.60)(字体处理后) 大小，98M -> 67.6MB, -31%

- https://theplanttokyo.atlassian.net/browse/MDX-1856 

  - prompt when typing/pasting invalid symbols in password field

  - invalid sample: 123$#%@12313ggg

  - 这个问题不需要解决，因为会直接使用 inputfiter 拦截掉，因此无法黏贴成功

  - 但是发现了一个另外的问题，代码层面的：

    - LoginEditView 控件的问题：在填写入内容的时候，父类 LoginCommonView 已经添加了 @OnTextChanged({R.id.loginEditText})，由于底层的持有 OnTextChangedListener 的是一个 list，子类的 @OnTextChanged 并不会覆盖父类的，因此：

      - LoginCommonView.onTextChanged -> onValidate(false) -> doValidate(true): LoginBaseView 覆写了
      - 接着：LoginEditView.onTextChanged -> LoginCommonView.onValidate(true: focused, s) -> LoginCommonView.onValidate(true) -> doValidate(true): LoginBaseView 覆写了

      以上为重复调用问题的一个原因，还有第二个原因，ButterKnife 框架的误用：

      ButterKnife 没 bind(view) 一次，底层就会使用 apt 生成一个 xxView_viewbinding$N 类来进行事件监听器的注册，findviewById 代码的编写，因此：

      - 以上的继承关系，每个类里面都有 bind(view) 代码，意味着 apt 会生成多个内部类，也就意味着事件（onTextChanged）会添加多次，具体证据可以看 debug 下的调用 stack，可以看到多个 xxView_viewbinding$N 类，调用 onTextChangedListener

    - **老代码不知道这种重复 binding 的情况有多少**



## 2020/12/22 Tuesday

- 插入任务，https://theplanttokyo.atlassian.net/browse/MDX-1879，理解需求，发现多个版本



## 2020/12/23 Wednesday

- 读 Caffee Stamp 的代码

- 处理 Caffee Stamp 的冲突：https://theplanttokyo.atlassian.net/browse/MDX-1879

  

## 2020/12/24 Thursday

- 客户发现 Surfaceview  系统级 bug， revert 加载动画页面和控件，并且把所有系统都测试一遍
- 继承处理 Caffee Stamp 的冲突：https://theplanttokyo.atlassian.net/browse/MDX-1879



## 2020/12/25 Friday

- https://theplanttokyo.atlassian.net/browse/MMF-87 不改业务逻辑，但是需要添加 password 错误字符提示
- 阅读 Remote Config 文档



## 2020/12/28 Monday

- ~~https://theplanttokyo.atlassian.net/browse/MDX-1889 remote config control qrcode scan entrance show/hide~~
- ~~https://theplanttokyo.atlassian.net/browse/MDX-1899 Send My Order to Kitchen 替换 Proceed to Pick Up~~



## 2020/12/29 Tuesday

## 2020/12/30 Wednesday

## 2020/12/31 Thursday

- duplicate GET /v3/configurations calls

  - https://theplanttokyo.atlassian.net/browse/MDX-1872  /configurations /consumers

    /consumers/me/tagvalues 多发问题和总结



## 2021/01/01 Friday

元旦放假



## 2021/01/04 Monday

## 2021/01/05 Tuesday

done：

- https://theplanttokyo.atlassian.net/browse/MMF-92
- https://theplanttokyo.atlassian.net/browse/MMF-91



## 2021/01/06 Wednesday

- 修改 Caffe Stamp 流程
- 修改 Caffee Stamp 的 UI 适配短屏幕



## 2021/01/07 Thursday

- 添加 VS 任务首页活动结束状态
- 熟悉 VS 任务及拆分和目标



## 2021/01/08 Friday

- 首页 banner 点击进入，以及网页点击进入活动，并打包

  - 首页 banner 的结束 ui 显示条件改为 end = timestr 使用 localtime 判断

    

## 2021/01/11- 2021/01/15

- VS 三天半的开发，1.5 天配合 QA 测试 bug 修复，还不包括加班的时间



## 2021/01/18-2021/01/22

## 2021/01/25-2021/01/29

- 25-26 
  - https://theplanttokyo.atlassian.net/browse/MDX-1886
  - https://theplanttokyo.atlassian.net/browse/MDX-1740

## 2021/02/08 - 2021/02/10

### 02/08

- 熟悉 sprint 21 所有未开始的任务，并评估
- 完成 https://theplanttokyo.atlassian.net/browse/MDX-1972 Duplicate Product Image call. Actual SP：3 (4 hours)

### 02/09

- 执行https://theplanttokyo.atlassian.net/browse/MDX-1984 Update SDK to v3.2.0，完成 并测试了 prod 环境

- 执行 https://theplanttokyo.atlassian.net/browse/MDX-1967 Value Stamp Card Design Change

  > Updated the heading in the tutorials (Slide: page 2) /done
  >
  > Updated the disclaimer in the tutorial 1 (Slide: page 2) /done
  >
  > Updated the screen title of stamp page (Slide: page 4) /done
  >
  > Updated the disclaimer in the stamp page (Slide: page 4) /done
  >
  > Updated the campaign end date in the stamp page (Slide: page 4) /done. API work, date field of data had updated
  >
  > Image files will be updated by Dentsu /not done. waiting util 21-2-18. API work. it should be updated by backend
  >
  > 
  >
  > [Request for fix] /done
  >
  > Regarding the number on the bottom right in the stamp card, please start from 1 (currently it starts from 0). It should show the count of cards user currently has. (Slide: page 4)
  >
  > 
  >
  > [Other changes]
  >
  > Please see the comments in the Google sheet which start with “For The Plant”.
  >
  > - 利用规约(T&C)：https://www.mcdonalds.co.jp/private/value-lunch-faq is not in config.term_url /not done. API work
  > - Please use the latest image from below https://lion.box.com/s/2gdvzumfn743mcvyfz8oh3pgpdg9g7lr /done
  > - FAQ URL Change：https://www.mcdonalds.co.jp/private/value-lunch-faq is not in config.faq_url /not done. API work

```
{
    "campaign_end":"2021-03-12T14:00:00+09:00",
    "faq_url":"https://www.mcdonalds.co.jp/privacy/?m\u003d1",
    "images":{
        "bg_vs_auth":"https://www.stg.mcd.qorcommerce.com/mobile_assets/valuelunch-stamp-card/bg_vs_auth.png",
        "bg_vs_header":"https://www.stg.mcd.qorcommerce.com/mobile_assets/valuelunch-stamp-card/bg_vs_header.png",
        "bg_vs_tutorial_1":"https://www.stg.mcd.qorcommerce.com/mobile_assets/valuelunch-stamp-card/bg_vs_tutorial_1.png",
        "bg_vs_tutorial_2":"https://www.stg.mcd.qorcommerce.com/mobile_assets/valuelunch-stamp-card/bg_vs_tutorial_2.png",
        "ico_vs_stamp_left":"https://www.stg.mcd.qorcommerce.com/mobile_assets/valuelunch-stamp-card/ico_vs_stamp_left.png",
        "ico_vs_stamp_right":"https://www.stg.mcd.qorcommerce.com/mobile_assets/valuelunch-stamp-card/ico_vs_stamp_right.png"
    },
    "lcpf":"ValueLunch_2102",
    "participant_tag_name":"202102_VLMOP_Participant",
    "products":[
        800043,
        800044,
        800045,
        800046,
        800047,
        800048
    ],
    "term_url":"https://www.mcdonalds.co.jp/policy/?m\u003d1"
}
```

- https://docs.google.com/presentation/d/1JVjGnUxN7zO1bC2kMrsLQlOtfRETq7TowXA2ZUBPV-g/edit#slide=id.p

- https://www.figma.com/file/A92ZX0msfzy4T4OZcaFBib/Others---Value-Lunch-Campaign?node-id=361%3A10891



### 02/10

- https://theplanttokyo.atlassian.net/browse/MDX-1969 Replace JMA splash image
  - /done，提交了 pr（ASP：2）
- https://theplanttokyo.atlassian.net/browse/MMF-112 Terms and condition page > Header issues
  -  /checked. CMS had fixed it 
- https://theplanttokyo.atlassian.net/browse/MMF-122 Stamps page display several times
  - /fixed. （ASP：2）
